<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1262927411271648"
     crossorigin="anonymous"></script>
    <title>URL Performance Analyzer | TajNova Free Tool (Real API)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --color-primary: #f97316; --color-success: #10b981; --color-error: #ef4444; }
        body { font-family: 'Cairo', sans-serif; background-color: #f8fafc; }
        .analyzer-card { border-top: 5px solid var(--color-primary); }
        .text-error { color: var(--color-error); }
        .text-success { color: var(--color-success); }
        
        /* تأثير الحركة عند ظهور النتائج */
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0; 
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* حركة نبض خفيف مستمر للنص الجانبي */
        .pulse-infinite {
            animation: pulseOnce 1.5s ease-in-out infinite; 
        }
        /* حركة نبض تعمل مرة واحدة لاسم الأداة */
        .pulse-once {
            animation: pulseOnce 1.5s ease-in-out;
        }
        @keyframes pulseOnce {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="text-slate-800">

    <header class="bg-white shadow-lg">
        <div class="max-w-4xl mx-auto p-6 flex justify-between items-center">
            
            <div class="flex items-center">
                <img src="images/logotagnova.png" alt="TajNova Logo" class="h-16 w-auto ml-3">
                
                <h1 class="text-4xl font-extrabold pulse-once" style="color: var(--color-primary);">
                     URL Performance Analyzer
                </h1>
            </div>
            
            <div class="flex items-center space-x-4 space-x-reverse"> 
                
                <a href="index.html" class="text-xl font-semibold text-slate-600 hover:text-orange-600 transition duration-200">الرئيسية (Home)</a>

                <span class="text-2xl font-bold text-slate-500 pulse-infinite">TajNova Free Tool (Real Data)</span>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-10 px-4 sm:px-6 lg:px-8">
        
        <p class="mb-8 text-lg text-slate-600">
            أدخل رابط الموقع (URL) لتحليل أداء الصفحة والحصول على توصيات تحسين مُحددة لمعايير Core Web Vitals **بناءً على بيانات Google الحقيقية**.
        </p>

        <section class="bg-white p-8 rounded-xl shadow-2xl mb-10 analyzer-card">
            
            <form id="url-analysis-form" class="flex flex-nowrap items-center gap-2">
                <input 
                    type="url" 
                    id="target-url" 
                    placeholder="أدخل رابط الموقع هنا (مثل: https://example.com)" 
                    required 
                    class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-primary transition duration-200 text-right"
                />
                <button 
                    type="submit" 
                    id="analyze-button"
                    class="p-3 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 transition duration-300 flex-shrink-0 flex items-center justify-center min-w-[150px]"
                >
                    <i class="fas fa-cogs ml-2"></i> تحليل الأداء
                </button>
            </form>
            <p id="error-message" class="mt-3 text-sm text-error hidden"></p>
        </section>

        <section id="results-container" class="mt-12 hidden">
            <h2 class="text-2xl font-bold mb-6 text-slate-700 flex items-center">
                <i class="fas fa-tachometer-alt ml-2" style="color: var(--color-primary);"></i> نتائج التحليل والتوصيات
            </h2>

            <div id="summary-card" class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h3 class="text-xl font-semibold mb-4 text-primary">ملخص حالة الموقع (<span id="summary-score">...</span>)</h3>
                <div id="lcp-status" class="flex items-center mb-2">
                    <span class="font-medium w-40">LCP Status:</span>
                    <span class="mr-2 font-bold text-gray-600 text-left w-full">...</span>
                </div>
                <div id="cls-status" class="flex items-center mb-2">
                    <span class="font-medium w-40">CLS Status:</span>
                    <span class="mr-2 font-bold text-gray-600 text-left w-full">...</span>
                </div>
                <div id="inp-status" class="flex items-center">
                    <span class="font-medium w-40">TBT/Responsiveness:</span>
                    <span class="mr-2 font-bold text-gray-600 text-left w-full">...</span>
                </div>
            </div>

            <div id="recommendations-list" class="space-y-4">
            </div>
        </section>

        <div id="loading-indicator" class="mt-12 text-center hidden">
            <i class="fas fa-spinner fa-spin text-4xl" style="color: var(--color-primary);"></i>
            <p class="mt-3 text-lg text-slate-600">جارٍ تحليل الرابط. يتصل الخادم بـ Google PageSpeed Insights... (قد يستغرق 5-10 ثوانٍ)</p>
        </div>

    </main>

    <script>
        const BACKEND_ENDPOINT = 'http://localhost:3000/api/analyze';

        const getMetricStatus = (metricValue, goodThreshold, badThreshold) => {
            let icon, color, status;
            if (metricValue <= goodThreshold) {
                icon = 'fa-check-circle';
                color = 'text-success';
                status = 'جيد';
            } else if (metricValue < badThreshold) {
                icon = 'fa-exclamation-triangle';
                color = 'text-yellow-500';
                status = 'متوسط';
            } else {
                icon = 'fa-times-circle';
                color = 'text-error';
                status = 'ضعيف';
            }
            return { icon, color, status };
        };

        const displayResults = (data) => {
            const auditData = data.lighthouseResult.audits;
            const categories = data.lighthouseResult.categories;
            const performanceScore = Math.round(categories.performance.score * 100);
            
            const lcp = auditData['largest-contentful-paint'].numericValue / 1000;
            const cls = auditData['cumulative-layout-shift'].numericValue;
            // استخدام TBT كبديل مؤقت لـ INP (التفاعل) لضمان العمل
            const tbt = auditData['total-blocking-time'].numericValue; 

            const lcpStatus = getMetricStatus(lcp, 2.5, 4.0);
            const clsStatus = getMetricStatus(cls, 0.1, 0.25);
            const tbtStatus = getMetricStatus(tbt, 300, 600);

            document.getElementById('summary-score').textContent = `نتيجة الأداء: ${performanceScore}/100`;

            document.getElementById('lcp-status').querySelector('span:last-child').innerHTML = 
                `<i class="fas ${lcpStatus.icon} ${lcpStatus.color} ml-1"></i> ${lcpStatus.status} (${lcp.toFixed(2)}s)`;
            
            document.getElementById('cls-status').querySelector('span:last-child').innerHTML = 
                `<i class="fas ${clsStatus.icon} ${clsStatus.color} ml-1"></i> ${clsStatus.status} (${cls.toFixed(3)})`;
            
            document.getElementById('inp-status').querySelector('span:last-child').innerHTML = 
                `<i class="fas ${tbtStatus.icon} ${tbtStatus.color} ml-1"></i> ${tbtStatus.status} (${tbt.toFixed(0)}ms)`;

            let recommendationsHtml = `<h3 class="text-xl font-semibold mb-3 text-slate-700">خطوات التحسين المقترحة:</h3>`;
            
            const performanceAudits = categories.performance.auditRefs
                .filter(ref => ref.group === 'load-opportunities' && auditData[ref.id].score !== 1)
                .slice(0, 5);

            if (performanceAudits.length > 0) {
                performanceAudits.forEach(ref => {
                    const audit = auditData[ref.id];
                    
                    const isCritical = audit.score < 0.5;
                    const color = isCritical ? 'error' : 'yellow-500';
                    const bgColor = isCritical ? 'red-100' : 'yellow-100';
                    const textColor = isCritical ? 'red-800' : 'yellow-800';
                    const priorityText = isCritical ? 'عاجل' : 'متوسط';

                    const displayValue = audit.displayValue || 'غير متوفر';
                    const descriptionText = audit.description ? audit.description.split('. ')[0] : 'لا يوجد وصف متاح.';

                    recommendationsHtml += `
                        <div class="bg-${bgColor} p-4 rounded-lg border-r-4 border-${color}" dir="rtl">
                            <p class="font-bold text-${textColor}"><i class="fas ${isCritical ? 'fa-exclamation-circle' : 'fa-minus-circle'} ml-2"></i> ${priorityText}: ${audit.title}</p>
                            <p class="text-sm mt-1 text-${textColor}">
                                ${descriptionText}. (توفير مُقدّر: ${displayValue})
                            </p>
                        </div>
                    `;
                });
            } else {
                 recommendationsHtml += `
                    <div class="bg-green-100 p-4 rounded-lg border-r-4 border-success">
                        <p class="font-bold text-success"><i class="fas fa-check-circle ml-2"></i> تهانينا!</p>
                        <p class="text-sm mt-1 text-success-800">أداء الموقع ممتاز ولا توجد فرص تحسين واضحة في التحليل الحالي.</p>
                    </div>
                `;
            }

            document.getElementById('recommendations-list').innerHTML = recommendationsHtml;
            
            // تفعيل حركة الظهور هنا
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.classList.remove('hidden');
            resultsContainer.classList.add('fade-in-up');
        };

        document.getElementById('url-analysis-form').addEventListener('submit', function(e) {
            e.preventDefault();

            const targetUrl = document.getElementById('target-url').value.trim();
            const resultsContainer = document.getElementById('results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const errorMessage = document.getElementById('error-message');
            const analyzeButton = document.getElementById('analyze-button');

            if (!targetUrl || !targetUrl.startsWith('http')) {
                errorMessage.textContent = 'الرجاء إدخال رابط صالح (يبدأ بـ http/https).';
                errorMessage.classList.remove('hidden');
                return;
            }
            
            errorMessage.classList.add('hidden');
            // إخفاء الـ Fade-in-up قبل التحليل لتطبيقها عند ظهور النتائج
            resultsContainer.classList.remove('fade-in-up'); 
            resultsContainer.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> جاري التحليل';

            fetch(BACKEND_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: targetUrl })
            })
            .then(response => {
                // معالجة الأخطاء من الخادم الخلفي (مثل 400، 403، 500)
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.details || err.error || `HTTP ${response.status} Error`); });
                }
                return response.json();
            })
            .then(data => {
                displayResults(data);
            })
            .catch(error => {
                console.error('Analysis Failed:', error);
                // عرض رسالة الخطأ الدقيقة المستلمة من الخادم
                errorMessage.textContent = `فشل التحليل: ${error.message}. يرجى التأكد من تشغيل الخادم والمفتاح.`;
                errorMessage.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            })
            .finally(() => {
                loadingIndicator.classList.add('hidden');
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = '<i class="fas fa-cogs ml-2"></i> تحليل الأداء';
            });
        });
    </script>
</body>
</html>